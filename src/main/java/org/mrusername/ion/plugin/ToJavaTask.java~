package org.mrusername.ion.plugin;

import org.gradle.api.DefaultTask;
import org.gradle.api.tasks.TaskAction;
import org.mrusername.ion.core.lang.Figure;
import org.mrusername.ion.core.util.IonFiles;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.StandardCopyOption;

public abstract class ToJavaTask extends DefaultTask {
    private File sourceDir;
    private File outputDir;

    public void setSourceDir(File sourceDir) {
        this.sourceDir = sourceDir;
    }

    public void setOutputDir(File outputDir) {
        this.outputDir = outputDir;
    }

    @TaskAction
    public void transformFiles() {
        IonPlugins.createDir(outputDir);
        IonPlugins.forEachFile(sourceDir.toPath(), ".java", path -> {
            try {
                Path relativePath = sourceDir.toPath().relativize(path);
                Path targetPath = outputDir.toPath().resolve(relativePath);
                Files.createDirectories(targetPath.getParent());
                Files.copy(path, targetPath, StandardCopyOption.REPLACE_EXISTING);
                Figure figure = new Figure(IonFiles.read(path), path.getFileName().toString());
                Files.writeString(targetPath, figure.toString());
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        });
    }
}